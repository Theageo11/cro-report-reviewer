{% extends "base.html" %}

{% block title %}å·¥ä½œå° - æ˜æ·åŒ»è¯æŠ¥å‘Šå®¡æ ¸Demo{% endblock %}

{% block content %}
<!-- Top Bar -->
<div class="flex items-center justify-between gap-4 mb-6">
    <div class="flex items-center gap-3">
        <button onclick="toggleSidebar()" class="lg:hidden p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
            <i data-lucide="menu" class="w-6 h-6 text-gray-700 dark:text-gray-300"></i>
        </button>
        <h1 class="text-2xl font-semibold text-gray-900 dark:text-gray-50">
            å·¥ä½œå°
        </h1>
    </div>

    <div class="flex items-center gap-3">
        <!-- Search -->
        <div class="hidden sm:flex relative">
            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
            <input
                type="text"
                placeholder="æœç´¢..."
                class="w-64 h-10 pl-9 pr-4 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-full text-sm text-gray-900 dark:text-gray-100 placeholder:text-gray-500 focus:outline-none focus:border-primary-500 focus:ring-1 focus:ring-primary-500/30 transition-colors"
            />
        </div>

        <!-- New Document Button -->
        <button onclick="document.getElementById('fileInput').click()" class="hidden sm:flex items-center gap-2 h-10 px-6 bg-primary-600 hover:bg-primary-700 text-white rounded-full text-sm font-medium transition-colors">
            <i data-lucide="plus" class="w-4 h-4"></i>
            <span>æ–°å»ºå®¡æ ¸ä»»åŠ¡</span>
        </button>
        <input type="file" id="fileInput" accept=".docx" style="display: none;" onchange="handleFileUpload(event)">

        <!-- User -->
        <button class="flex items-center gap-2 p-1 pr-3 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
            <div class="w-8 h-8 bg-primary-500 rounded-full flex items-center justify-center">
                <i data-lucide="user-circle" class="w-5 h-5 text-white"></i>
            </div>
            <span class="hidden sm:block text-sm font-medium text-gray-700 dark:text-gray-200">
                Admin
            </span>
        </button>
    </div>
</div>

<!-- Page Title & Total Count -->
<div class="mb-6">
    <p class="text-sm text-gray-500 dark:text-gray-400">
        å…± <span class="font-semibold text-gray-900 dark:text-gray-50">{{ documents|length }}</span> ä»½æ£€æµ‹æŠ¥å‘Š
    </p>
</div>

<!-- Stats Row -->
{% set critical_count = documents|selectattr('status', 'equalto', 'analyzed')|selectattr('critical_count', 'gt', 0)|list|length %}
{% set major_count = documents|selectattr('status', 'equalto', 'analyzed')|selectattr('major_count', 'gt', 0)|list|length %}
{% set analyzed_count = documents|selectattr('status', 'equalto', 'analyzed')|list|length %}
{% set total_count = documents|length %}

<div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3 sm:gap-4 mb-6 w-full">
    <!-- High Risk -->
    <div class="flex flex-col items-center justify-center p-4 rounded-2xl border shadow-sm hover:shadow-md transition-all duration-200 bg-red-50 text-red-600 border-red-200 dark:bg-red-950/30 dark:border-red-900/30 dark:text-red-400">
        <span class="text-3xl font-bold mb-1">{{ critical_count }}</span>
        <span class="text-xs font-medium uppercase tracking-wide">é«˜é£é™©</span>
    </div>
    
    <!-- Medium Risk -->
    <div class="flex flex-col items-center justify-center p-4 rounded-2xl border shadow-sm hover:shadow-md transition-all duration-200 bg-orange-50 text-orange-600 border-orange-200 dark:bg-orange-950/30 dark:border-orange-900/30 dark:text-orange-400">
        <span class="text-3xl font-bold mb-1">{{ major_count }}</span>
        <span class="text-xs font-medium uppercase tracking-wide">ä¸­é£é™©</span>
    </div>
    
    <!-- Low Risk -->
    <div class="flex flex-col items-center justify-center p-4 rounded-2xl border shadow-sm hover:shadow-md transition-all duration-200 bg-green-50 text-green-600 border-green-200 dark:bg-green-950/30 dark:border-green-900/30 dark:text-green-400">
        <span class="text-3xl font-bold mb-1">{{ analyzed_count - critical_count - major_count }}</span>
        <span class="text-xs font-medium uppercase tracking-wide">ä½é£é™©</span>
    </div>
    
    <!-- Approved -->
    <div class="flex flex-col items-center justify-center p-4 rounded-2xl border shadow-sm hover:shadow-md transition-all duration-200 bg-blue-50 text-blue-600 border-blue-200 dark:bg-blue-950/30 dark:border-blue-900/30 dark:text-blue-400">
        <span class="text-3xl font-bold mb-1">{{ analyzed_count }}</span>
        <span class="text-xs font-medium uppercase tracking-wide">å·²é€šè¿‡</span>
    </div>
    
    <!-- Pending -->
    <div class="flex flex-col items-center justify-center p-4 rounded-2xl border shadow-sm hover:shadow-md transition-all duration-200 bg-gray-100 text-gray-600 border-gray-200 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400">
        <span class="text-3xl font-bold mb-1">{{ total_count - analyzed_count }}</span>
        <span class="text-xs font-medium uppercase tracking-wide">å¾…å®¡æ ¸</span>
    </div>
</div>

<!-- Filter Tabs -->
<div class="flex gap-2 mb-6 overflow-x-auto pb-2 scrollbar-hide w-full">
    <button onclick="filterDocuments('all')" class="filter-tab flex-shrink-0 h-10 px-6 rounded-full text-sm font-medium transition-colors bg-primary-500 text-white" data-filter="all">
        å…¨éƒ¨
    </button>
    <button onclick="filterDocuments('high')" class="filter-tab flex-shrink-0 h-10 px-6 rounded-full text-sm font-medium transition-colors bg-transparent text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800" data-filter="high">
        é«˜é£é™©
    </button>
    <button onclick="filterDocuments('medium')" class="filter-tab flex-shrink-0 h-10 px-6 rounded-full text-sm font-medium transition-colors bg-transparent text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800" data-filter="medium">
        ä¸­é£é™©
    </button>
    <button onclick="filterDocuments('low')" class="filter-tab flex-shrink-0 h-10 px-6 rounded-full text-sm font-medium transition-colors bg-transparent text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800" data-filter="low">
        ä½é£é™©
    </button>
    <button onclick="filterDocuments('approved')" class="filter-tab flex-shrink-0 h-10 px-6 rounded-full text-sm font-medium transition-colors bg-transparent text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800" data-filter="approved">
        å·²é€šè¿‡
    </button>
    <button onclick="filterDocuments('pending')" class="filter-tab flex-shrink-0 h-10 px-6 rounded-full text-sm font-medium transition-colors bg-transparent text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800" data-filter="pending">
        å¾…å®¡æ ¸
    </button>
</div>

<!-- Document Grid -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 w-full" id="document-grid">
    {% for doc in documents %}
    {% set risk_level = 'pending' %}
    {% if doc.status == 'analyzed' %}
        {% if doc.critical_count > 0 %}
            {% set risk_level = 'high' %}
        {% elif doc.major_count > 0 %}
            {% set risk_level = 'medium' %}
        {% else %}
            {% set risk_level = 'low' %}
        {% endif %}
        {% if doc.quality_score >= 90 %}
            {% set risk_level = 'approved' %}
        {% endif %}
    {% endif %}
    
    <div class="document-card flex flex-col p-4 bg-white dark:bg-gray-800 rounded-2xl shadow-sm hover:shadow-lg border border-gray-200 dark:border-gray-700 gap-3 transition-all duration-200 cursor-pointer" 
         onclick="window.location.href='{{ url_for('document_detail', doc_id=doc.id) }}'"
         data-risk="{{ risk_level }}">
        <!-- Header -->
        <div class="flex items-start justify-between gap-2">
            <div class="flex items-center gap-2 min-w-0 flex-1">
                <div class="flex-shrink-0 w-10 h-10 bg-primary-100 dark:bg-primary-900/30 rounded-lg flex items-center justify-center">
                    <i data-lucide="file-spreadsheet" class="w-5 h-5 text-primary-600 dark:text-primary-400"></i>
                </div>
                <div class="min-w-0 flex-1">
                    <p class="text-sm font-medium text-gray-900 dark:text-gray-50 truncate">
                        {{ doc.original_filename }}
                    </p>
                </div>
            </div>
            <span class="flex-shrink-0 inline-flex items-center px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-xs rounded-lg">
                æŠ¥å‘Š
            </span>
        </div>

        <!-- AI Score -->
        {% if doc.status == 'analyzed' %}
        <div class="flex items-center gap-2">
            <div class="flex items-center gap-1.5 px-2 py-1 bg-primary-100 dark:bg-primary-900/30 rounded-lg">
                <span class="text-xs font-medium text-primary-700 dark:text-primary-300">
                    IA {{ doc.quality_score }}%
                </span>
            </div>
        </div>
        {% endif %}

        <!-- Risk Box -->
        {% if doc.status == 'analyzed' %}
        <div class="p-3 rounded-lg border
            {% if doc.critical_count > 0 %}bg-red-50 border-red-200 dark:bg-red-950/30 dark:border-red-900/30
            {% elif doc.major_count > 0 %}bg-orange-50 border-orange-200 dark:bg-orange-950/30 dark:border-orange-900/30
            {% else %}bg-green-50 border-green-200 dark:bg-green-950/30 dark:border-green-900/30
            {% endif %}">
            <p class="text-xs font-semibold uppercase tracking-wide mb-1 text-gray-500 dark:text-gray-400">
                é£é™©æ‘˜è¦
            </p>
            <p class="text-sm
                {% if doc.critical_count > 0 %}text-red-700 dark:text-red-300
                {% elif doc.major_count > 0 %}text-orange-700 dark:text-orange-300
                {% else %}text-green-700 dark:text-green-300
                {% endif %}">
                {% if doc.critical_count > 0 %}å‘ç° {{ doc.critical_count }} ä¸ªä¸¥é‡é—®é¢˜
                {% elif doc.major_count > 0 %}å‘ç° {{ doc.major_count }} ä¸ªä¸»è¦é—®é¢˜
                {% elif doc.minor_count > 0 %}å‘ç° {{ doc.minor_count }} ä¸ªæ¬¡è¦é—®é¢˜
                {% else %}æœªå‘ç°é—®é¢˜
                {% endif %}
            </p>
        </div>
        {% else %}
        <div class="p-3 rounded-lg border bg-gray-100 border-gray-200 dark:bg-gray-800 dark:border-gray-700">
            <p class="text-xs font-semibold uppercase tracking-wide mb-1 text-gray-500 dark:text-gray-400">
                çŠ¶æ€
            </p>
            <p class="text-sm text-gray-700 dark:text-gray-300">
                {% if doc.status == 'analyzing' %}æ­£åœ¨åˆ†æä¸­...{% else %}ç­‰å¾…åˆ†æ{% endif %}
            </p>
        </div>
        {% endif %}

        <!-- Action Button -->
        <button class="w-full h-10 rounded-lg text-sm font-medium transition-colors
            {% if doc.status == 'analyzed' and doc.quality_score >= 90 %}bg-primary-500 text-white hover:bg-primary-600
            {% else %}border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700
            {% endif %}"
            onclick="event.stopPropagation(); {% if doc.status == 'analyzed' %}window.location.href='{{ url_for('document_detail', doc_id=doc.id) }}'{% else %}analyzeDocument('{{ doc.id }}'){% endif %}">
            {% if doc.status == 'analyzed' %}æŸ¥çœ‹è¯¦æƒ…{% else %}ç«‹å³å®¡æ ¸{% endif %}
        </button>
    </div>
    {% endfor %}
</div>

<!-- Empty State -->
{% if not documents %}
<div class="flex flex-col items-center justify-center py-16 px-4">
    <div class="w-16 h-16 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mb-4">
        <p class="text-3xl">ğŸ“„</p>
    </div>
    <p class="text-lg font-medium text-gray-900 dark:text-gray-50 mb-2">
        æœªæ‰¾åˆ°ç›¸å…³æŠ¥å‘Š
    </p>
    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
        ä¸Šä¼ æ‚¨çš„ç¬¬ä¸€ä¸ªæŠ¥å‘Šæ–‡æ¡£å¼€å§‹å®¡æ ¸
    </p>
    <button onclick="document.getElementById('fileInput').click()" class="flex items-center gap-2 h-10 px-6 bg-primary-600 hover:bg-primary-700 text-white rounded-full text-sm font-medium transition-colors">
        <i data-lucide="upload" class="w-4 h-4"></i>
        <span>ä¸Šä¼ æ–‡æ¡£</span>
    </button>
</div>
{% endif %}

<!-- Loading Overlay -->
<div id="loadingOverlay" class="fixed inset-0 bg-black/70 z-[90] hidden items-center justify-center">
    <div class="bg-white dark:bg-gray-800 rounded-2xl p-8 text-center">
        <div class="w-16 h-16 border-4 border-primary-200 border-t-primary-600 rounded-full animate-spin mx-auto mb-4"></div>
        <p id="loadingText" class="text-gray-700 dark:text-gray-200 font-medium">å¤„ç†ä¸­...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Initialize icons
lucide.createIcons();

// Filter documents
function filterDocuments(filter) {
    const cards = document.querySelectorAll('.document-card');
    const tabs = document.querySelectorAll('.filter-tab');
    
    // Update active tab
    tabs.forEach(tab => {
        if (tab.dataset.filter === filter) {
            tab.className = 'filter-tab flex-shrink-0 h-10 px-6 rounded-full text-sm font-medium transition-colors bg-primary-500 text-white hover:bg-primary-600 dark:hover:bg-primary-400';
        } else {
            tab.className = 'filter-tab flex-shrink-0 h-10 px-6 rounded-full text-sm font-medium transition-colors bg-transparent text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800';
        }
    });
    
    // Filter cards
    cards.forEach(card => {
        if (filter === 'all' || card.dataset.risk === filter) {
            card.style.display = 'flex';
        } else {
            card.style.display = 'none';
        }
    });
}

// Upload file
async function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');
    loadingOverlay.classList.remove('hidden');
    loadingOverlay.classList.add('flex');
    loadingText.textContent = 'æ­£åœ¨ä¸Šä¼ æ–‡æ¡£...';
    
    const formData = new FormData();
    formData.append('file', file);
    
    try {
        const response = await fetch('/api/upload', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('ä¸Šä¼ æˆåŠŸï¼', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.error || 'ä¸Šä¼ å¤±è´¥', 'error');
        }
    } catch (error) {
        showToast('ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
    } finally {
        loadingOverlay.classList.add('hidden');
        loadingOverlay.classList.remove('flex');
        event.target.value = '';
    }
}

// Analyze document
async function analyzeDocument(docId) {
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');
    loadingOverlay.classList.remove('hidden');
    loadingOverlay.classList.add('flex');
    loadingText.textContent = 'AI æ­£åœ¨åˆ†ææ–‡æ¡£...';
    
    try {
        const response = await fetch(`/api/analyze/${docId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ use_mock: false })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('åˆ†æå®Œæˆï¼', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.error || 'åˆ†æå¤±è´¥', 'error');
        }
    } catch (error) {
        showToast('åˆ†æå¤±è´¥: ' + error.message, 'error');
    } finally {
        loadingOverlay.classList.add('hidden');
        loadingOverlay.classList.remove('flex');
    }
}
</script>
{% endblock %}
