{% extends "base.html" %}

{% block title %}å·¥ä½œå° - æ˜æ·åŒ»è¯æŠ¥å‘Šå®¡æ ¸Demo{% endblock %}

{% block content %}
<!-- Top Bar -->
<div class="flex items-center justify-between gap-4 mb-6">
    <div class="flex items-center gap-3">
        <button onclick="toggleSidebar()" class="lg:hidden p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
            <i data-lucide="menu" class="w-6 h-6 text-gray-700 dark:text-gray-300"></i>
        </button>
        <h1 class="text-2xl font-semibold text-gray-900 dark:text-gray-50">
            å·¥ä½œå°
        </h1>
    </div>

    <div class="flex items-center gap-3">
        <!-- Search -->
        <div class="hidden sm:flex relative">
            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
            <input
                type="text"
                placeholder="æœç´¢..."
                class="w-64 h-10 pl-9 pr-4 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-full text-sm text-gray-900 dark:text-gray-100 placeholder:text-gray-500 focus:outline-none focus:border-primary-500 focus:ring-1 focus:ring-primary-500/30 transition-colors"
            />
        </div>

        <!-- New Document Button -->
        <button onclick="document.getElementById('fileInput').click()" class="hidden sm:flex items-center gap-2 h-10 px-6 bg-primary-600 hover:bg-primary-700 text-white rounded-full text-sm font-medium transition-colors">
            <i data-lucide="plus" class="w-4 h-4"></i>
            <span>æ–°å»ºå®¡æ ¸ä»»åŠ¡</span>
        </button>
        <input type="file" id="fileInput" accept=".docx" style="display: none;" onchange="handleFileUpload(event)">

        <!-- Theme Toggle -->
        <button onclick="toggleTheme()" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" title="åˆ‡æ¢ä¸»é¢˜">
            <i id="theme-icon" data-lucide="moon" class="w-5 h-5 text-gray-600 dark:text-gray-400"></i>
        </button>

        <!-- User -->
        <button class="flex items-center gap-2 p-1 pr-3 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
            <div class="w-8 h-8 bg-primary-500 rounded-full flex items-center justify-center">
                <i data-lucide="user-circle" class="w-5 h-5 text-white"></i>
            </div>
            <span class="hidden sm:block text-sm font-medium text-gray-700 dark:text-gray-200">
                Admin
            </span>
        </button>
    </div>
</div>

<!-- Page Title & Total Count -->
<div class="mb-6">
    <p class="text-sm text-gray-500 dark:text-gray-400">
        å…± <span class="font-semibold text-gray-900 dark:text-gray-50">{{ documents|length }}</span> ä»½æ£€æµ‹æŠ¥å‘Š
    </p>
</div>

<!-- Stats Row -->
{% set analyzed_count = risk_stats.high + risk_stats.medium + risk_stats.low + risk_stats.passed %}
{% set total_count = documents|length %}

<div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3 sm:gap-4 mb-6 w-full">
    <!-- High Risk -->
    <div class="flex flex-col items-center justify-center p-4 rounded-2xl border shadow-sm hover:shadow-md transition-all duration-200 bg-red-50 text-red-600 border-red-200 dark:bg-red-950/30 dark:border-red-900/30 dark:text-red-400">
        <span class="text-3xl font-bold mb-1">{{ risk_stats.high }}</span>
        <span class="text-xs font-medium uppercase tracking-wide">é«˜é£é™©</span>
    </div>
    
    <!-- Medium Risk -->
    <div class="flex flex-col items-center justify-center p-4 rounded-2xl border shadow-sm hover:shadow-md transition-all duration-200 bg-orange-50 text-orange-600 border-orange-200 dark:bg-orange-950/30 dark:border-orange-900/30 dark:text-orange-400">
        <span class="text-3xl font-bold mb-1">{{ risk_stats.medium }}</span>
        <span class="text-xs font-medium uppercase tracking-wide">ä¸­é£é™©</span>
    </div>
    
    <!-- Low Risk -->
    <div class="flex flex-col items-center justify-center p-4 rounded-2xl border shadow-sm hover:shadow-md transition-all duration-200 bg-blue-50 text-blue-600 border-blue-200 dark:bg-blue-950/30 dark:border-blue-900/30 dark:text-blue-400">
        <span class="text-3xl font-bold mb-1">{{ risk_stats.low }}</span>
        <span class="text-xs font-medium uppercase tracking-wide">ä½é£é™©</span>
    </div>
    
    <!-- Passed -->
    <div class="flex flex-col items-center justify-center p-4 rounded-2xl border shadow-sm hover:shadow-md transition-all duration-200 bg-green-50 text-green-600 border-green-200 dark:bg-green-950/30 dark:border-green-900/30 dark:text-green-400">
        <span class="text-3xl font-bold mb-1">{{ risk_stats.passed }}</span>
        <span class="text-xs font-medium uppercase tracking-wide">å·²é€šè¿‡</span>
    </div>

    <!-- Analyzed Total -->
    <div class="flex flex-col items-center justify-center p-4 rounded-2xl border shadow-sm hover:shadow-md transition-all duration-200 bg-primary-50 text-primary-600 border-primary-200 dark:bg-primary-950/30 dark:border-primary-900/30 dark:text-primary-400">
        <span class="text-3xl font-bold mb-1">{{ analyzed_count }}</span>
        <span class="text-xs font-medium uppercase tracking-wide">å·²åˆ†æ</span>
    </div>
    
    <!-- Pending -->
    <div class="flex flex-col items-center justify-center p-4 rounded-2xl border shadow-sm hover:shadow-md transition-all duration-200 bg-gray-100 text-gray-600 border-gray-200 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400">
        <span class="text-3xl font-bold mb-1">{{ total_count - analyzed_count }}</span>
        <span class="text-xs font-medium uppercase tracking-wide">å¾…å®¡æ ¸</span>
    </div>
</div>

<!-- Filter Tabs -->
<div class="flex gap-2 mb-6 overflow-x-auto pb-2 scrollbar-hide w-full">
    <button onclick="filterDocuments('all')" class="filter-tab flex-shrink-0 h-10 px-6 rounded-full text-sm font-medium transition-colors bg-primary-500 text-white" data-filter="all">
        å…¨éƒ¨
    </button>
    <button onclick="filterDocuments('high')" class="filter-tab flex-shrink-0 h-10 px-6 rounded-full text-sm font-medium transition-colors bg-transparent text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800" data-filter="high">
        é«˜é£é™©
    </button>
    <button onclick="filterDocuments('medium')" class="filter-tab flex-shrink-0 h-10 px-6 rounded-full text-sm font-medium transition-colors bg-transparent text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800" data-filter="medium">
        ä¸­é£é™©
    </button>
    <button onclick="filterDocuments('low')" class="filter-tab flex-shrink-0 h-10 px-6 rounded-full text-sm font-medium transition-colors bg-transparent text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800" data-filter="low">
        ä½é£é™©
    </button>
    <button onclick="filterDocuments('passed')" class="filter-tab flex-shrink-0 h-10 px-6 rounded-full text-sm font-medium transition-colors bg-transparent text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800" data-filter="passed">
        å·²é€šè¿‡
    </button>
    <button onclick="filterDocuments('pending')" class="filter-tab flex-shrink-0 h-10 px-6 rounded-full text-sm font-medium transition-colors bg-transparent text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800" data-filter="pending">
        å¾…å®¡æ ¸
    </button>
</div>

<!-- Document List -->
<div class="bg-white dark:bg-gray-900 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-800 overflow-hidden w-full">
    <table class="w-full text-left border-collapse">
        <thead>
            <tr class="bg-gray-50 dark:bg-gray-800/50 border-b border-gray-200 dark:border-gray-800">
                <th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">æ–‡ä»¶å</th>
                <th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">ä¸Šä¼ äºº</th>
                <th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">ä¸Šä¼ æ—¶é—´</th>
                <th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider text-center">AIè¯„åˆ†</th>
                <th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">é£é™©ç­‰çº§</th>
                <th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider text-right">æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="document-grid">
            {% for doc in documents %}
            {% set risk_level = 'pending' %}
            {% set risk_label = 'ç­‰å¾…åˆ†æ' %}
            {% set risk_class = 'bg-gray-100 text-gray-600 dark:bg-gray-800 dark:text-gray-400' %}
            
            {% if doc.status == 'analyzed' %}
                {% set score = doc.quality_score|default(0) %}
                {% if score == 100 %}
                    {% set risk_level = 'passed' %}
                    {% set risk_label = 'å·²é€šè¿‡' %}
                    {% set risk_class = 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' %}
                {% elif score >= 80 %}
                    {% set risk_level = 'low' %}
                    {% set risk_label = 'ä½é£é™©' %}
                    {% set risk_class = 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400' %}
                {% elif score >= 60 %}
                    {% set risk_level = 'medium' %}
                    {% set risk_label = 'ä¸­é£é™©' %}
                    {% set risk_class = 'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-400' %}
                {% else %}
                    {% set risk_level = 'high' %}
                    {% set risk_label = 'é«˜é£é™©' %}
                    {% set risk_class = 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400' %}
                {% endif %}
            {% elif doc.status == 'analyzing' %}
                {% set risk_label = 'æ­£åœ¨åˆ†æ...' %}
                {% set risk_class = 'bg-primary-100 text-primary-700 dark:bg-primary-900/30 dark:text-primary-400 animate-pulse' %}
            {% endif %}
            
            <tr class="document-card border-b border-gray-100 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors cursor-pointer" 
                onclick="location.href='/documents/{{ doc.id }}'"
                data-risk="{{ risk_level }}">
                <td class="px-6 py-4">
                    <div class="flex items-center gap-3">
                        <div class="flex-shrink-0 w-8 h-8 bg-primary-100 dark:bg-primary-900/30 rounded-lg flex items-center justify-center">
                            <i data-lucide="file-spreadsheet" class="w-4 h-4 text-primary-600 dark:text-primary-400"></i>
                        </div>
                        <span class="text-sm font-medium text-gray-900 dark:text-gray-50 truncate max-w-xs">
                            {{ doc.original_filename }}
                        </span>
                    </div>
                </td>
                <td class="px-6 py-4">
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 bg-gray-200 dark:bg-gray-700 rounded-full flex items-center justify-center">
                            <i data-lucide="user" class="w-3 h-3 text-gray-500 dark:text-gray-400"></i>
                        </div>
                        <span class="text-sm text-gray-600 dark:text-gray-300">{{ doc.uploader|default('Admin') }}</span>
                    </div>
                </td>
                <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400">
                    {{ doc.created_at[:10] }}
                </td>
                <td class="px-6 py-4 text-center">
                    {% if doc.status == 'analyzed' %}
                    <span class="text-sm font-bold text-primary-600 dark:text-primary-400">{{ doc.quality_score }}</span>
                    {% else %}
                    <span class="text-gray-300 dark:text-gray-700">-</span>
                    {% endif %}
                </td>
                <td class="px-6 py-4">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {{ risk_class }}">
                        {{ risk_label }}
                    </span>
                </td>
                <td class="px-6 py-4 text-right">
                    <div class="flex items-center justify-end gap-2">
                        {% if doc.status == 'analyzed' %}
                        <button onclick="event.stopPropagation(); location.href='/documents/{{ doc.id }}'" 
                                class="p-2 text-gray-400 hover:text-primary-600 dark:hover:text-primary-400 transition-colors" title="æŸ¥çœ‹è¯¦æƒ…">
                            <i data-lucide="eye" class="w-4 h-4"></i>
                        </button>
                        {% else %}
                        <button onclick="event.stopPropagation(); analyzeDocument('{{ doc.id }}')" 
                                class="p-2 text-gray-400 hover:text-primary-600 dark:hover:text-primary-400 transition-colors" title="ç«‹å³åˆ†æ">
                            <i data-lucide="play" class="w-4 h-4"></i>
                        </button>
                        {% endif %}
                        <div class="relative">
                            <button onclick="event.stopPropagation(); toggleActionMenu('{{ doc.id }}')" class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors">
                                <i data-lucide="more-horizontal" class="w-4 h-4"></i>
                            </button>
                            <div id="action-menu-{{ doc.id }}" class="hidden absolute right-0 top-10 w-40 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg z-10">
                                {% if doc.status == 'analyzed' %}
                                <button onclick="event.stopPropagation(); reanalyzeDocument('{{ doc.id }}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2 rounded-t-lg">
                                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                    <span>é‡æ–°åˆ†æ</span>
                                </button>
                                {% endif %}
                                <button onclick="event.stopPropagation(); deleteDocument('{{ doc.id }}')" class="w-full px-4 py-2 text-left text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-950/30 flex items-center gap-2 rounded-b-lg">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    <span>åˆ é™¤æ–‡æ¡£</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Empty State -->
{% if not documents %}
<div class="flex flex-col items-center justify-center py-16 px-4">
    <div class="w-16 h-16 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mb-4">
        <p class="text-3xl">ğŸ“„</p>
    </div>
    <p class="text-lg font-medium text-gray-900 dark:text-gray-50 mb-2">
        æœªæ‰¾åˆ°ç›¸å…³æŠ¥å‘Š
    </p>
    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
        ä¸Šä¼ æ‚¨çš„ç¬¬ä¸€ä¸ªæŠ¥å‘Šæ–‡æ¡£å¼€å§‹å®¡æ ¸
    </p>
    <button onclick="document.getElementById('fileInput').click()" class="flex items-center gap-2 h-10 px-6 bg-primary-600 hover:bg-primary-700 text-white rounded-full text-sm font-medium transition-colors">
        <i data-lucide="upload" class="w-4 h-4"></i>
        <span>ä¸Šä¼ æ–‡æ¡£</span>
    </button>
</div>
{% endif %}

<!-- Loading Overlay -->
<div id="loadingOverlay" class="fixed inset-0 bg-black/70 z-[90] hidden items-center justify-center">
    <div class="bg-white dark:bg-gray-800 rounded-2xl p-8 text-center">
        <div class="w-16 h-16 border-4 border-primary-200 border-t-primary-600 rounded-full animate-spin mx-auto mb-4"></div>
        <p id="loadingText" class="text-gray-700 dark:text-gray-200 font-medium">å¤„ç†ä¸­...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Initialize icons
lucide.createIcons();

// Filter documents
function filterDocuments(filter) {
    const cards = document.querySelectorAll('.document-card');
    const tabs = document.querySelectorAll('.filter-tab');
    
    // Update active tab
    tabs.forEach(tab => {
        if (tab.dataset.filter === filter) {
            tab.className = 'filter-tab flex-shrink-0 h-10 px-6 rounded-full text-sm font-medium transition-colors bg-primary-500 text-white hover:bg-primary-600 dark:hover:bg-primary-400';
        } else {
            tab.className = 'filter-tab flex-shrink-0 h-10 px-6 rounded-full text-sm font-medium transition-colors bg-transparent text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800';
        }
    });
    
    // Filter cards
    cards.forEach(card => {
        if (filter === 'all' || card.dataset.risk === filter) {
            card.style.display = 'flex';
        } else {
            card.style.display = 'none';
        }
    });
}

// Upload file
async function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');
    loadingOverlay.classList.remove('hidden');
    loadingOverlay.classList.add('flex');
    loadingText.textContent = 'æ­£åœ¨ä¸Šä¼ æ–‡æ¡£...';
    
    const formData = new FormData();
    formData.append('file', file);
    
    try {
        const response = await fetch('/api/upload', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('ä¸Šä¼ æˆåŠŸï¼', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.error || 'ä¸Šä¼ å¤±è´¥', 'error');
        }
    } catch (error) {
        showToast('ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
    } finally {
        loadingOverlay.classList.add('hidden');
        loadingOverlay.classList.remove('flex');
        event.target.value = '';
    }
}

// Analyze document
async function analyzeDocument(docId) {
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');
    loadingOverlay.classList.remove('hidden');
    loadingOverlay.classList.add('flex');
    loadingText.textContent = 'AI æ­£åœ¨åˆ†ææ–‡æ¡£...';
    
    try {
        const response = await fetch(`/api/analyze/${docId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ use_mock: false })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('åˆ†æå®Œæˆï¼', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.error || 'åˆ†æå¤±è´¥', 'error');
        }
    } catch (error) {
        showToast('åˆ†æå¤±è´¥: ' + error.message, 'error');
    } finally {
        loadingOverlay.classList.add('hidden');
        loadingOverlay.classList.remove('flex');
    }
}

// Reanalyze document
async function reanalyzeDocument(docId) {
    if (!confirm('ç¡®å®šè¦é‡æ–°åˆ†ææ­¤æ–‡æ¡£å—ï¼Ÿè¿™å°†è¦†ç›–ç°æœ‰çš„åˆ†æç»“æœã€‚')) {
        return;
    }
    
    await analyzeDocument(docId);
}

// Delete document
async function deleteDocument(docId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤æ–‡æ¡£å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) {
        return;
    }
    
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');
    loadingOverlay.classList.remove('hidden');
    loadingOverlay.classList.add('flex');
    loadingText.textContent = 'æ­£åœ¨åˆ é™¤æ–‡æ¡£...';
    
    try {
        const response = await fetch(`/api/documents/${docId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('åˆ é™¤æˆåŠŸï¼', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.error || 'åˆ é™¤å¤±è´¥', 'error');
        }
    } catch (error) {
        showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
    } finally {
        loadingOverlay.classList.add('hidden');
        loadingOverlay.classList.remove('flex');
    }
}

// Toggle action menu
function toggleActionMenu(docId) {
    const menu = document.getElementById(`action-menu-${docId}`);
    const allMenus = document.querySelectorAll('[id^="action-menu-"]');
    
    // Close all other menus
    allMenus.forEach(m => {
        if (m.id !== `action-menu-${docId}`) {
            m.classList.add('hidden');
        }
    });
    
    // Toggle current menu
    menu.classList.toggle('hidden');
}

// Close menus when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('[id^="action-menu-"]') && !event.target.closest('button[onclick*="toggleActionMenu"]')) {
        const allMenus = document.querySelectorAll('[id^="action-menu-"]');
        allMenus.forEach(m => m.classList.add('hidden'));
    }
});

</script>
{% endblock %}
