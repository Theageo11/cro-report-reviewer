{% extends "base.html" %}

{% block title %}{{ document.original_filename }} - 明捷医药报告审核Demo{% endblock %}

{% block content %}
{# Define styles for different issue types #}
{% set styles = {
    'Critical': {
        'icon': 'alert-circle',
        'bg': 'bg-red-50 dark:bg-red-950/30',
        'border': 'border-red-200 dark:border-red-900/30',
        'icon_color': 'text-red-500',
        'title_color': 'text-red-700 dark:text-red-400',
        'badge_bg': 'bg-red-100 dark:bg-red-900/50',
        'badge_text': 'text-red-700 dark:text-red-300',
        'label': '严重'
    },
    'Major': {
        'icon': 'alert-triangle',
        'bg': 'bg-orange-50 dark:bg-orange-950/30',
        'border': 'border-orange-200 dark:border-orange-900/30',
        'icon_color': 'text-orange-500',
        'title_color': 'text-orange-700 dark:text-orange-400',
        'badge_bg': 'bg-orange-100 dark:bg-orange-900/50',
        'badge_text': 'text-orange-700 dark:text-orange-300',
        'label': '警告'
    },
    'Minor': {
        'icon': 'info',
        'bg': 'bg-blue-50 dark:bg-blue-950/30',
        'border': 'border-blue-200 dark:border-blue-900/30',
        'icon_color': 'text-blue-500',
        'title_color': 'text-blue-700 dark:text-blue-400',
        'badge_bg': 'bg-blue-100 dark:bg-blue-900/50',
        'badge_text': 'text-blue-700 dark:text-blue-300',
        'label': '提示'
    }
} %}

<div class="h-[calc(100vh-6rem)] flex flex-col">
    <!-- Top Bar - Fixed -->
    <div class="flex-shrink-0 flex items-center justify-between gap-4 mb-6">
        <div class="flex items-center gap-3">
            <button onclick="window.location.href='{{ url_for('documents') }}'" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                <i data-lucide="arrow-left" class="w-5 h-5 text-gray-700 dark:text-gray-300"></i>
            </button>
            <div>
                <h1 class="text-xl font-semibold text-gray-900 dark:text-gray-50">
                    文档审核
                </h1>
                <p class="text-sm text-gray-500 dark:text-gray-400">
                    {{ document.original_filename }}
                </p>
            </div>
        </div>

        <div class="flex items-center gap-3">
            {% if document.status == 'analyzed' %}
            <div class="flex items-center gap-2 px-4 py-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl">
                <div class="text-xs text-gray-500 dark:text-gray-400">
                    AI评分:
                </div>
                <div class="text-lg font-bold text-primary-600 dark:text-primary-400">
                    {{ document.quality_score }}分
                </div>
            </div>

            <button onclick="downloadDocument('{{ document.id }}')" class="px-6 py-2.5 bg-primary-500 hover:bg-primary-600 text-white text-sm font-medium rounded-xl transition-colors">
                下载审核报告
            </button>
            {% else %}
            <button onclick="analyzeDocument('{{ document.id }}')" class="px-6 py-2.5 bg-primary-500 hover:bg-primary-600 text-white text-sm font-medium rounded-xl transition-colors">
                开始分析
            </button>
            {% endif %}
            
            <!-- Theme Toggle -->
            <button onclick="toggleTheme()" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" title="切换主题">
                <i id="theme-icon" data-lucide="moon" class="w-5 h-5 text-gray-600 dark:text-gray-400"></i>
            </button>
        </div>
    </div>

    <!-- Review Content - Takes remaining height -->
    <div class="flex-1 flex flex-col lg:flex-row gap-6 min-h-0 overflow-hidden">
        <!-- Left: Document Preview (60%) -->
        <div class="min-h-0 h-full overflow-hidden lg:w-[60%]">
            <div class="h-full flex flex-col bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
                <!-- Header - Fixed -->
                <div class="flex-shrink-0 px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900">
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-50">
                        文档预览
                    </h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                        原始文档内容展示
                    </p>
                </div>

                <!-- Content - Scrollable -->
                <div class="flex-1 overflow-y-auto overflow-x-hidden p-6" id="document-preview">
                    {% if document.status == 'uploaded' %}
                    <div class="flex items-center justify-center h-full text-gray-400 dark:text-gray-500">
                        <div class="text-center">
                            <i data-lucide="info" class="w-16 h-16 mx-auto mb-4"></i>
                            <p class="text-lg mb-2">点击"开始分析"以查看文档内容和问题</p>
                        </div>
                    </div>
                    {% elif document.status == 'analyzing' %}
                    <div class="flex items-center justify-center h-full text-gray-400 dark:text-gray-500">
                        <div class="text-center">
                            <div class="w-16 h-16 border-4 border-primary-200 border-t-primary-600 rounded-full animate-spin mx-auto mb-4"></div>
                            <p class="text-lg">正在分析中，请稍候...</p>
                        </div>
                    </div>
                    {% else %}
                    <div class="prose prose-sm dark:prose-invert max-w-none document-html-container">
                        {{ html_content|safe }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right: Review Comments (40%) -->
        <div class="min-h-0 h-full overflow-hidden lg:w-[40%]">
            {% if document.status == 'analyzed' and document.issues %}
            <div class="h-full flex flex-col bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
                <!-- Header - Fixed -->
                <div class="flex-shrink-0 px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-50">
                                AI审核意见
                            </h2>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                                共 {{ document.issues|length }} 条评审意见
                            </p>
                        </div>
                        <div class="flex items-center gap-2">
                            {% set score = document.quality_score|default(0) %}
                            {% if score == 100 %}
                            <div class="flex items-center gap-1.5 px-3 py-1.5 bg-green-100 dark:bg-green-900/30 rounded-full">
                                <div class="w-2 h-2 rounded-full bg-green-500"></div>
                                <span class="text-xs font-medium text-green-700 dark:text-green-300">已通过</span>
                            </div>
                            {% elif score >= 80 %}
                            <div class="flex items-center gap-1.5 px-3 py-1.5 bg-blue-100 dark:bg-blue-900/30 rounded-full">
                                <div class="w-2 h-2 rounded-full bg-blue-500"></div>
                                <span class="text-xs font-medium text-blue-700 dark:text-blue-300">低风险</span>
                            </div>
                            {% elif score >= 60 %}
                            <div class="flex items-center gap-1.5 px-3 py-1.5 bg-orange-100 dark:bg-orange-900/30 rounded-full">
                                <div class="w-2 h-2 rounded-full bg-orange-500"></div>
                                <span class="text-xs font-medium text-orange-700 dark:text-orange-300">中风险</span>
                            </div>
                            {% else %}
                            <div class="flex items-center gap-1.5 px-3 py-1.5 bg-red-100 dark:bg-red-900/30 rounded-full">
                                <div class="w-2 h-2 rounded-full bg-red-500"></div>
                                <span class="text-xs font-medium text-red-700 dark:text-red-300">高风险</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Comments List - Scrollable -->
                <div class="flex-1 overflow-y-auto p-4 space-y-3">
                    {% for issue in document.issues %}
                    {% set style = styles.get(issue.issue_type, styles['Minor']) %}
                    
                    <div class="border rounded-xl overflow-hidden transition-all duration-200 {{ style.bg }} {{ style.border }} {% if issue.issue_type == 'Critical' %}is-critical{% endif %}" id="comment-{{ loop.index0 }}" data-index="{{ loop.index0 }}">
                        <!-- Comment Header -->
                        <div class="flex items-start gap-0">
                            <!-- Checkbox for selection -->
                            <div class="pl-4 pt-4">
                                <input type="checkbox" checked class="issue-checkbox w-4 h-4 text-primary-600 rounded border-gray-300 focus:ring-primary-500" data-index="{{ loop.index0 }}">
                            </div>
                            
                            <button onclick="toggleComment({{ loop.index0 }})" class="flex-1 px-4 py-3 flex items-start gap-3 hover:opacity-80 transition-opacity">
                                <div class="flex-shrink-0 mt-0.5 {{ style.icon_color }}">
                                    <i data-lucide="{{ style.icon }}" class="w-5 h-5"></i>
                                </div>

                                <div class="flex-1 min-w-0 text-left">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium {{ style.badge_bg }} {{ style.badge_text }}">
                                            {{ style.label }}
                                        </span>
                                        <h3 class="text-sm font-semibold flex-1 {{ style.title_color }}">
                                            {{ issue.description[:50] }}{% if issue.description|length > 50 %}...{% endif %}
                                        </h3>
                                    </div>
                                    <p class="text-xs text-gray-600 dark:text-gray-400 line-clamp-2">
                                        {{ issue.suggestion }}
                                    </p>
                                </div>

                                <div class="flex-shrink-0 mt-1 text-gray-400 {{ style.icon_color }} comment-chevron-{{ loop.index0 }}">
                                    <i data-lucide="chevron-right" class="w-4 h-4"></i>
                                </div>
                            </button>
                        </div>

                        <!-- Expanded Details -->
                        <div class="comment-details-{{ loop.index0 }} hidden px-3 pb-3 pt-1">
                            <div class="pl-6 border-l-2 border-gray-300 dark:border-gray-600 ml-2">
                                <div class="space-y-2 mb-2">
                                    <div>
                                        <p class="text-xs font-semibold text-gray-700 dark:text-gray-300 mb-0.5">问题描述</p>
                                        <p class="text-xs text-gray-600 dark:text-gray-400 leading-snug">{{ issue.description }}</p>
                                    </div>
                                    <div>
                                        <p class="text-xs font-semibold text-gray-700 dark:text-gray-300 mb-0.5">修改建议</p>
                                        <p class="text-xs text-gray-600 dark:text-gray-400 leading-snug">{{ issue.suggestion }}</p>
                                    </div>
                                    <div>
                                        <p class="text-xs font-semibold text-gray-700 dark:text-gray-300 mb-0.5">原文内容</p>
                                        <code class="block px-2 py-1 bg-white dark:bg-gray-900 rounded text-xs text-gray-700 dark:text-gray-300">{{ issue.original_text }}</code>
                                    </div>
                                </div>

                                <div class="flex items-center gap-2">
                                    <button onclick="scrollToIssue({{ loop.index0 }})" class="inline-flex items-center gap-1 px-2.5 py-1 bg-primary-500 hover:bg-primary-600 text-white text-xs font-medium rounded-lg transition-colors">
                                        <span>跳转查看</span>
                                        <i data-lucide="arrow-right" class="w-3 h-3"></i>
                                    </button>
                                    <button onclick="acceptIssue({{ loop.index0 }})" class="inline-flex items-center gap-1 px-2.5 py-1 bg-green-500 hover:bg-green-600 text-white text-xs font-medium rounded-lg transition-colors">
                                        <i data-lucide="check" class="w-3 h-3"></i>
                                        <span>接受修改</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% else %}
            <div class="h-full flex flex-col bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
                <div class="flex-shrink-0 px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900">
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-50">
                        AI审核意见
                    </h2>
                </div>
                <div class="flex-1 flex items-center justify-center text-gray-400 dark:text-gray-500">
                    <div class="text-center">
                        <i data-lucide="list" class="w-16 h-16 mx-auto mb-4"></i>
                        <p class="text-lg">暂无分析结果</p>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="fixed inset-0 bg-black/70 z-[90] hidden items-center justify-center">
    <div class="bg-white dark:bg-gray-800 rounded-2xl p-8 text-center">
        <div class="w-16 h-16 border-4 border-primary-200 border-t-primary-600 rounded-full animate-spin mx-auto mb-4"></div>
        <p id="loadingText" class="text-gray-700 dark:text-gray-200 font-medium">处理中...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Initialize icons
lucide.createIcons();

// Toggle comment expansion
function toggleComment(index) {
    const details = document.querySelector(`.comment-details-${index}`);
    const chevron = document.querySelector(`.comment-chevron-${index}`);
    const chevronIcon = chevron.querySelector('i');
    
    if (details.classList.contains('hidden')) {
        details.classList.remove('hidden');
        chevronIcon.setAttribute('data-lucide', 'chevron-down');
    } else {
        details.classList.add('hidden');
        chevronIcon.setAttribute('data-lucide', 'chevron-right');
    }
    
    lucide.createIcons();
}

// Scroll to issue in preview
function scrollToIssue(issueIndex) {
    const previewContent = document.getElementById('document-preview');
    const targetElement = document.querySelector(`#issue-${issueIndex}`);
    
    if (targetElement && previewContent) {
        // Get positions
        const containerRect = previewContent.getBoundingClientRect();
        const targetRect = targetElement.getBoundingClientRect();
        
        // Calculate scroll position
        const scrollTop = previewContent.scrollTop + (targetRect.top - containerRect.top) - (containerRect.height / 2) + (targetRect.height / 2);
        
        // Smooth scroll
        previewContent.scrollTo({
            top: scrollTop,
            behavior: 'smooth'
        });
        
        // Highlight animation
        targetElement.style.animation = 'pulse 1s ease-in-out';
        setTimeout(() => {
            targetElement.style.animation = '';
        }, 1000);
    }
}

// Accept issue and mark as resolved
function acceptIssue(issueIndex) {
    const button = event.target.closest('button');
    const issueItem = button.closest('.border-b');
    
    // Check if already accepted
    if (button.classList.contains('bg-gray-400')) {
        showToast('此问题已被接受', 'info');
        return;
    }
    
    // Mark as accepted
    button.classList.remove('bg-green-500', 'hover:bg-green-600');
    button.classList.add('bg-gray-400', 'cursor-not-allowed');
    button.disabled = true;
    button.innerHTML = '<i data-lucide="check-check" class="w-3 h-3"></i><span>已接受</span>';
    
    // Re-initialize lucide icons for the new icon
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
    
    // Add visual feedback to the issue item
    issueItem.style.opacity = '0.6';
    issueItem.style.transition = 'opacity 0.3s';
    
    showToast('已接受此修改建议', 'success');
}


// Analyze document
async function analyzeDocument(docId) {
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');
    loadingOverlay.classList.remove('hidden');
    loadingOverlay.classList.add('flex');
    loadingText.textContent = 'AI 正在分析文档...';
    
    try {
        const response = await fetch(`/api/analyze/${docId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ use_mock: false })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('分析完成！', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.error || '分析失败', 'error');
        }
    } catch (error) {
        showToast('分析失败: ' + error.message, 'error');
    } finally {
        loadingOverlay.classList.add('hidden');
        loadingOverlay.classList.remove('flex');
    }
}

// Download document
async function downloadDocument(docId) {
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');
    
    // Get selected indices
    const checkboxes = document.querySelectorAll('.issue-checkbox:checked');
    const selectedIndices = Array.from(checkboxes).map(cb => cb.getAttribute('data-index')).join(',');
    
    if (selectedIndices.length === 0) {
        if (!confirm('您没有选择任何审核意见，下载的文档将不包含批注。是否继续？')) {
            return;
        }
    }

    loadingOverlay.classList.remove('hidden');
    loadingOverlay.classList.add('flex');
    loadingText.textContent = '正在生成审核报告...';
    
    try {
        window.location.href = `/api/download/${docId}?selected_indices=${selectedIndices}`;
        showToast('正在下载...', 'success');
    } catch (error) {
        showToast('下载失败: ' + error.message, 'error');
    } finally {
        setTimeout(() => {
            loadingOverlay.classList.add('hidden');
            loadingOverlay.classList.remove('flex');
        }, 1000);
    }
}

// Auto-expand critical issues
document.addEventListener('DOMContentLoaded', function() {
    const criticalElements = document.querySelectorAll('.is-critical');
    criticalElements.forEach(el => {
        const index = el.getAttribute('data-index');
        if (index !== null) {
            toggleComment(parseInt(index));
        }
    });
});
</script>

<style>
@keyframes pulse {
    0%, 100% {
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
    }
    50% {
        box-shadow: 0 0 20px 10px rgba(239, 68, 68, 0.4);
    }
}

.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* 文档预览样式增强 - 确保表格和其他元素正确显示 */
.prose table,
.document-html-container table {
    border-collapse: collapse !important;
    width: 100% !important;
    margin: 1rem 0 !important;
    border: 1px solid #e5e7eb !important;
}

.prose th,
.prose td,
.document-html-container th,
.document-html-container td {
    border: 1px solid #e5e7eb !important;
    padding: 0.75rem !important;
    text-align: left !important;
}

.dark .prose th,
.dark .prose td,
.dark .document-html-container th,
.dark .document-html-container td {
    border-color: #374151 !important;
}

.prose th,
.document-html-container th {
    background-color: #f9fafb !important;
    font-weight: 600 !important;
}

.dark .prose th,
.dark .document-html-container th {
    background-color: #1f2937 !important;
}

.prose tr:nth-child(even),
.document-html-container tr:nth-child(even) {
    background-color: #f9fafb;
}

.dark .prose tr:nth-child(even),
.dark .document-html-container tr:nth-child(even) {
    background-color: #111827;
}

.prose img,
.document-html-container img {
    max-width: 100% !important;
    height: auto !important;
    display: block !important;
    margin: 1rem 0 !important;
    border-radius: 8px !important;
}

.prose p,
.document-html-container p {
    margin: 0.5rem 0 !important;
    line-height: 1.6 !important;
}
</style>
{% endblock %}
