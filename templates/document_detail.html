{% extends "base.html" %}

{% block title %}{{ document.original_filename }} - æ˜æ·åŒ»è¯æŠ¥å‘Šå®¡æ ¸Demo{% endblock %}

{% block content %}
<!-- è¿”å›æŒ‰é’® -->
<div class="breadcrumb">
    <a href="{{ url_for('documents') }}"><i class="fas fa-arrow-left"></i> è¿”å›æ–‡æ¡£åˆ—è¡¨</a>
    <span class="separator">/</span>
    <span>{{ document.original_filename }}</span>
</div>

<!-- æ–‡æ¡£çŠ¶æ€å’Œè´¨é‡è¯„åˆ† -->
{% if document.status == 'analyzed' %}
<div class="detail-stats">
    <div class="stat-card-detail stat-score">
        <div class="stat-icon">ğŸ“Š</div>
        <div class="stat-info">
            <div class="stat-value">{{ document.quality_score }}</div>
            <div class="stat-label">è´¨é‡è¯„åˆ†</div>
        </div>
    </div>
    <div class="stat-card-detail stat-critical-detail">
        <div class="stat-icon">ğŸ”´</div>
        <div class="stat-info">
            <div class="stat-value">{{ document.critical_count }}</div>
            <div class="stat-label">ä¸¥é‡é—®é¢˜</div>
        </div>
    </div>
    <div class="stat-card-detail stat-major-detail">
        <div class="stat-icon">ğŸŸ¡</div>
        <div class="stat-info">
            <div class="stat-value">{{ document.major_count }}</div>
            <div class="stat-label">ä¸»è¦é—®é¢˜</div>
        </div>
    </div>
    <div class="stat-card-detail stat-minor-detail">
        <div class="stat-icon">ğŸ”µ</div>
        <div class="stat-info">
            <div class="stat-value">{{ document.minor_count }}</div>
            <div class="stat-label">æ¬¡è¦é—®é¢˜</div>
        </div>
    </div>
    <div class="stat-card-detail stat-total">
        <div class="stat-icon">ğŸ“</div>
        <div class="stat-info">
            <div class="stat-value">{{ document.issues|length }}</div>
            <div class="stat-label">æ€»é—®é¢˜æ•°</div>
        </div>
    </div>
</div>
{% endif %}

<!-- ä¸»å†…å®¹åŒºåŸŸ -->
<div class="detail-layout">
    <!-- å·¦ä¾§ï¼šæ–‡æ¡£é¢„è§ˆ -->
    <div class="detail-preview">
        <div class="preview-header">
            <h3><i class="fas fa-file-alt"></i> æ–‡æ¡£é¢„è§ˆ</h3>
            {% if document.status != 'analyzed' %}
            <button class="btn btn-primary btn-sm" onclick="analyzeDocument('{{ document.id }}')">
                <i class="fas fa-search"></i>
                å¼€å§‹åˆ†æ
            </button>
            {% endif %}
        </div>
        <div class="preview-content">
            {% if document.status == 'uploaded' %}
            <div class="preview-empty">
                <i class="fas fa-info-circle"></i>
                <p>ç‚¹å‡»"å¼€å§‹åˆ†æ"ä»¥æŸ¥çœ‹æ–‡æ¡£å†…å®¹å’Œé—®é¢˜</p>
            </div>
            {% elif document.status == 'analyzing' %}
            <div class="preview-empty">
                <div class="spinner"></div>
                <p>æ­£åœ¨åˆ†æä¸­ï¼Œè¯·ç¨å€™...</p>
            </div>
            {% else %}
            <div class="document-html-container">
                {{ html_content|safe }}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- å³ä¾§ï¼šé—®é¢˜åˆ—è¡¨ -->
    <div class="detail-issues">
        <div class="issues-header">
            <h3><i class="fas fa-exclamation-triangle"></i> é—®é¢˜åˆ—è¡¨</h3>
            {% if document.status == 'analyzed' and document.issues %}
            <button class="btn btn-success btn-sm" onclick="downloadDocument('{{ document.id }}')">
                <i class="fas fa-download"></i>
                ä¸‹è½½å®¡æ ¸æŠ¥å‘Š
            </button>
            {% endif %}
        </div>
        
        {% if document.status == 'analyzed' %}
            {% if document.issues %}
            <div class="issues-list">
                {% for issue in document.issues %}
                <div class="issue-item issue-{{ issue.issue_type.lower() }}" id="issue-card-{{ loop.index0 }}">
                    <div class="issue-header-item">
                        <span class="issue-number">#{{ loop.index }}</span>
                        <span class="issue-badge badge-{{ issue.issue_type.lower() }}">
                            {% if issue.issue_type == 'Critical' %}ä¸¥é‡
                            {% elif issue.issue_type == 'Major' %}ä¸»è¦
                            {% else %}æ¬¡è¦
                            {% endif %}
                        </span>
                    </div>
                    <div class="issue-content">
                        <h4 class="issue-title">{{ issue.description }}</h4>
                        <div class="issue-section">
                            <strong>ä¿®æ”¹å»ºè®®ï¼š</strong>
                            <p>{{ issue.suggestion }}</p>
                        </div>
                        <div class="issue-section">
                            <strong>åŸæ–‡å†…å®¹ï¼š</strong>
                            <code class="issue-original">{{ issue.original_text }}</code>
                        </div>
                        <button class="btn btn-link btn-sm" onclick="scrollToIssue({{ loop.index0 }})">
                            <i class="fas fa-location-arrow"></i>
                            å®šä½åˆ°åŸæ–‡
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="no-issues">
                <i class="fas fa-check-circle"></i>
                <h4>æ–‡æ¡£è´¨é‡ä¼˜ç§€</h4>
                <p>æœªå‘ç°é—®é¢˜</p>
            </div>
            {% endif %}
        {% else %}
        <div class="issues-empty">
            <i class="fas fa-list-alt"></i>
            <p>æš‚æ— åˆ†æç»“æœ</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner">
        <div class="spinner"></div>
        <p id="loadingText">å¤„ç†ä¸­...</p>
    </div>
</div>

<script>
// åˆ†ææ–‡æ¡£
async function analyzeDocument(docId) {
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');
    loadingOverlay.style.display = 'flex';
    loadingText.textContent = 'AI æ­£åœ¨åˆ†ææ–‡æ¡£...';
    
    try {
        const response = await fetch(`/api/analyze/${docId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ use_mock: false })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('åˆ†æå®Œæˆï¼', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.error || 'åˆ†æå¤±è´¥', 'error');
        }
    } catch (error) {
        showToast('åˆ†æå¤±è´¥: ' + error.message, 'error');
    } finally {
        loadingOverlay.style.display = 'none';
    }
}

// ä¸‹è½½æ–‡æ¡£
async function downloadDocument(docId) {
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');
    loadingOverlay.style.display = 'flex';
    loadingText.textContent = 'æ­£åœ¨ç”Ÿæˆå®¡æ ¸æŠ¥å‘Š...';
    
    try {
        window.location.href = `/api/download/${docId}`;
        showToast('æ­£åœ¨ä¸‹è½½...', 'success');
    } catch (error) {
        showToast('ä¸‹è½½å¤±è´¥: ' + error.message, 'error');
    } finally {
        setTimeout(() => {
            loadingOverlay.style.display = 'none';
        }, 1000);
    }
}

// æ»šåŠ¨åˆ°é—®é¢˜ä½ç½®
function scrollToIssue(issueIndex) {
    const previewContent = document.querySelector('.preview-content');
    const targetElement = document.querySelector(`#issue-${issueIndex}`);
    
    if (targetElement && previewContent) {
        // è·å–ç›®æ ‡å…ƒç´ ç›¸å¯¹äºé¢„è§ˆå®¹å™¨çš„ä½ç½®
        const containerRect = previewContent.getBoundingClientRect();
        const targetRect = targetElement.getBoundingClientRect();
        
        // è®¡ç®—æ»šåŠ¨ä½ç½®
        const scrollTop = previewContent.scrollTop + (targetRect.top - containerRect.top) - (containerRect.height / 2) + (targetRect.height / 2);
        
        // å¹³æ»‘æ»šåŠ¨
        previewContent.scrollTo({
            top: scrollTop,
            behavior: 'smooth'
        });
        
        // æ·»åŠ é«˜äº®åŠ¨ç”»
        targetElement.style.animation = 'highlight-pulse 1s ease-in-out';
        setTimeout(() => {
            targetElement.style.animation = '';
        }, 1000);
    } else {
        console.log('æœªæ‰¾åˆ°ç›®æ ‡å…ƒç´ :', `#issue-${issueIndex}`);
    }
}
</script>
{% endblock %}

